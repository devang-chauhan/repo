<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0 shrink-to-fit=no">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>HOK Script Repository</title>
  <link rel="icon" href="images/HOK_logo_RGB_jpg_lg.jpg" sizes="16x16">
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="bootstrap/js/jquery.slim.min.js"></script>
  <script src="bootstrap/js/tether.min.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>
  <script src="bootstrap/js/scripts.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      $.ajax({
        type: 'GET',
        url: 'data.json',
        dataType: 'json',
        success: jsonParser
      });
    });

    function jsonParser(json) {
      $('#load').fadeOut();

      $.getJSON('data.json', function(data) {
        var main = data;
        $.each(data.repo, function(k, v) {
          var filename = v.file;
          var thumbnail = v.thumbnail;
          var tags = v.tags;
          var class_id = v.class;

          // Load all the thumbnails
          $('#grid').append('<img class="card-images card-img-top img-fluid card-border" src="data/' + filename + '/' + thumbnail + '.png" id="' + filename + '" alt="' + tags + '"/>');
        });


        // Wrap all the images in anchor tag and supply Query Strings
        $(function() {
          $('#grid .card-images').each(function() { // For each image
            var a = $(this).attr('id');
            $(this).wrap('<a href="viewer.html?owner=' + a + '"></a>');
          });
        });


        // Wrap all anchor tags in section tag
        $(function() {
          $('#grid a').each(function() { // For each anchor tag
            var key = $(this).attr('href');
            var strippedkey = key.split("=");
            $(this).wrap('<section class="card mb-5 card-border show-border" id="' + strippedkey[1] + '"></section>')
          });
        });


        // Add a div tage inside each section tag
        $(function() {
          $('#grid section').each(function() { // For each section tag
            var key = $(this).attr('id');
            $(this).append('<div class="card-body" id="' + key + '"></div>')
          });
        });


        // add file name and tags to the div container
        $(function() {
          $('#grid .card-body').each(function() { // div tag defined above
            key = $(this).attr("id");
            cardName = key.replace("_", " ");
            $(this).append('<h6 class="font-weight-normal card-title mb-0 mt-0 text-capitalize">' + cardName + '</h6>');
            // var tagsToAdd = main.repo[key].tags;
            // $(this).append('<h7 class="card-subtitle mt-0 text-secondary">' + tagsToAdd + '</h7>');
          });
        });

        // Wrap all section tags in a div tag
        $(function() {
          $('#grid section').each(function() { // For each section tag
            let id_to_add = $(this).attr("id");
            $(this).wrap('<div class="col" id="' + id_to_add + '"></div>')
          });
        });

      });

    }


    // Search and hide cards
    function hide_cards() {

      $.getJSON('data.json', function(data) {
        var main = data;

        // Keyword provided by the user
        var search = document.getElementById('filtering').value;

        // Getting a list of all the cards
        var cards = main.repo;

        // Formatting all tags for processing later
        function format_array(array) {
          let formatted_tags = [];
          for (i = 0; i < array.length; i++) {
            let formatted_tag = (array[i].toLowerCase()).trim();
            formatted_tags.push(formatted_tag);
          }
          return formatted_tags;
        }


        // Checking if a part of keyword is in any of the tags
        function check_key_in_string(key, array) {
          var total = 0;
          for (i = 0; i < array.length; i++) {
            if (array[i].includes(key)) {
              total += 1;
            } else {}
          }
          return total;
        }


        // Filtering Card names based on search query
        function filter_cards(search) {
          let keyword_toCheck = search.toLowerCase();
          let keys = [];
          for (key in cards) {
            let tags = cards[key].tags;
            let tags_list = tags.split("#").slice(1, );
            let formatted_tag_list = format_array(tags_list);
            let tag_check = check_key_in_string(keyword_toCheck, formatted_tag_list);
            if (tag_check > 0) {
              keys.push(key);
            }
          }
          return keys;
        }


        // List of card to display
        var filtered_cards = filter_cards(search);
        var num_cards_to_display = filtered_cards.length;
        if (num_cards_to_display == 0) {
          // Following two lines need deleting. Just keeping here for sometime for testing
          // var node = document.getElementById('welcome');
          // node.innerHTML = '<span style="text-align:center">No scripts found. Please try an alternate keyword</span>';
          document.getElementById("welcome").innerHTML = "No scripts found";
        } else if (search.length == 0) {
          location.reload();
        }

        // Showing cards based on Search query
        $(function() {
          $('div .col').each(function() {
            key = $(this).attr("id"); //Get id value
            let visibility_check = filtered_cards.includes(key);
            if (visibility_check == false) {
              $(this).css({
                "display": "none"
              });
            } else {
              $(this).css({
                "display": "initial"
              });
            }
          });
        });

      });
    }
  </script>

</head>

<body>
  <!-- Navigation bar -->
  <nav class="navbar navbar-light navbar-expand-sm pb-4" style="background-color:white;">
    <div class="container">
      <img src="images/HOK_logo_RGB_jpg_lg.jpg" style="width:40px;" alt="HOK Logo">
      <span id="welcome" class="font-weight-normal" style="padding-left:10px;">Welcome to HOKware</span>
      <!-- <h2 class="navbar-brand m-0" style="color:rgb(249, 35, 47);" href="#">Script Repository</h2> -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#myTogglerNav" aria-controls="myTogglerNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="myTogglerNav">
        <div class="navbar-nav ml-auto">
          <a class="nav-item nav-link" href="about.html">About</a>
          <a class="nav-item nav-link disabled" href="#">Education</a>
          <a class="nav-item nav-link disabled" href="#">How to Contribute</a>
          <a class="nav-item nav-link"
            href="https://teams.microsoft.com/l/entity/com.microsoft.teamspace.tab.planner/_djb2_msteams_prefix_2772894784?context=%7B%22subEntityId%22%3Anull%2C%22channelId%22%3A%2219%3A8f5e1d726b8d44c2901df0087b6da8ad%40thread.skype%22%7D&groupId=d5027d70-7fab-44be-85fe-e720db5db428&tenantId=3a18cb39-fa10-4a3d-a20a-905bbadc4da5">Feature
            Requests</a>
          <a class="nav-item nav-link disabled" href="#">Script Requests</a>
          <input class="nav-item nav-link font-weight-normal text-muted" type="text" id="filtering" placeholder="Search by keyword or Project" title="Filter the results by tag name or project name" size="25" oninput="hide_cards()" autocomplete="off"
            autofocus="autofocus">
        </div>
      </div>

    </div>
  </nav>


  <div class="container">

    <!-- <h6 title="Click on images to see the details and download the files..." style="padding-bottom:10px;">
      <span id="welcome" class="font-weight-normal">Welcome to HOKware</span>
      <span style="float:right;">
        <input class="font-weight-normal text-muted" type="text" id="filtering" placeholder="Search by keyword or Project" title="Filter the results by tag name or project name" size="25" oninput="hide_cards()">
      </span>
    </h6> -->

    <!-- Grid of Cards -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 rounded-lg text-center" id="grid"></div>

    <!-- Loader-->
    <!-- <div class="mx-auto d-block text-center">
        <img src="images/loading.gif" id="load" width="100" height="100" />
      </div> -->
  </div>

  <footer class="footer fixed-bottom" style="background-color:white;">
    <div class="container text-center">
      <h6 class="font-weight-normal text-muted">Powered by HOK Computational Design Group</h6>
    </div>
  </footer>
</body>

</html>